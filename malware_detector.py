import psutil
import os
from datetime import datetime
from database import ProcessEvent, ThreatSignature, AutomatedResponse, get_db

SUSPICIOUS_PROCESS_NAMES = [
    'cryptolocker', 'wannacry', 'ransomware', 'malware', 'trojan',
    'keylogger', 'rootkit', 'backdoor', 'exploit', 'payload'
]

RANSOMWARE_EXTENSIONS = [
    '.encrypted', '.locked', '.crypto', '.crypt', '.locky', '.cerber',
    '.zepto', '.odin', '.thor', '.aesir', '.zzzzz', '.micro', '.cryptowall',
    '.vault', '.xtbl', '.crinf', '.r5a', '.XRNT', '.XTBL', '.crypt', '.R16M01D05',
    '.pzdc', '.good', '.LOL!', '.OMG!', '.RDM', '.RRK', '.encryptedRSA',
    '.crjoker', '.LeChiffre', '.keybtc@inbox_com', '.0x0', '.bleep', '.1999',
    '.oxar', '.darkness'
]

HIGH_CPU_THRESHOLD = 80.0
HIGH_MEMORY_THRESHOLD = 70.0

def calculate_threat_score(process):
    score = 0.0
    
    try:
        cpu = process.cpu_percent(interval=0.1)
        memory = process.memory_percent()
        name = process.name().lower()
        
        if cpu > HIGH_CPU_THRESHOLD:
            score += 30.0
        elif cpu > 60.0:
            score += 15.0
        
        if memory > HIGH_MEMORY_THRESHOLD:
            score += 25.0
        elif memory > 50.0:
            score += 10.0
        
        for suspicious_name in SUSPICIOUS_PROCESS_NAMES:
            if suspicious_name in name:
                score += 50.0
                break
        
        try:
            num_files = len(process.open_files())
            if num_files > 100:
                score += 20.0
            elif num_files > 50:
                score += 10.0
        except (psutil.AccessDenied, psutil.NoSuchProcess):
            pass
        
        try:
            num_connections = len(process.connections())
            if num_connections > 50:
                score += 15.0
        except (psutil.AccessDenied, psutil.NoSuchProcess):
            pass
        
    except (psutil.NoSuchProcess, psutil.AccessDenied, psutil.ZombieProcess):
        score = 0.0
    
    return min(score, 100.0)

def scan_running_processes():
    suspicious_processes = []
    db = get_db()
    
    try:
        for process in psutil.process_iter(['pid', 'name', 'cpu_percent', 'memory_percent']):
            try:
                threat_score = calculate_threat_score(process)
                is_suspicious = threat_score >= 50.0
                
                if is_suspicious or threat_score > 0:
                    process_event = ProcessEvent(
                        process_name=process.name(),
                        process_id=process.pid,
                        cpu_percent=float(process.cpu_percent()),
                        memory_percent=float(process.memory_percent()),
                        threat_score=float(threat_score),
                        is_suspicious=is_suspicious,
                        details={
                            'cmdline': ' '.join(process.cmdline()) if process.cmdline() else '',
                            'username': process.username() if hasattr(process, 'username') else 'unknown'
                        }
                    )
                    db.add(process_event)
                    
                    if is_suspicious:
                        suspicious_processes.append({
                            'pid': process.pid,
                            'name': process.name(),
                            'threat_score': threat_score,
                            'cpu_percent': process.cpu_percent(),
                            'memory_percent': process.memory_percent()
                        })
            
            except (psutil.NoSuchProcess, psutil.AccessDenied, psutil.ZombieProcess):
                continue
        
        db.commit()
    finally:
        db.close()
    
    return suspicious_processes

def terminate_suspicious_process(pid, reason):
    db = get_db()
    success = False
    
    try:
        process = psutil.Process(pid)
        process_name = process.name()
        
        process.terminate()
        success = True
        
        response = AutomatedResponse(
            response_type='Process Termination',
            action_taken=f'Terminated suspicious process: {process_name} (PID: {pid})',
            target=f'{process_name}:{pid}',
            success=success,
            details={'reason': reason, 'pid': pid, 'name': process_name}
        )
        db.add(response)
        db.commit()
        
    except (psutil.NoSuchProcess, psutil.AccessDenied) as e:
        success = False
        response = AutomatedResponse(
            response_type='Process Termination Failed',
            action_taken=f'Failed to terminate process PID: {pid}',
            target=f'{pid}',
            success=False,
            details={'reason': reason, 'error': str(e)}
        )
        db.add(response)
        db.commit()
    finally:
        db.close()
    
    return success

def get_suspicious_processes_history(limit=50):
    db = get_db()
    try:
        return db.query(ProcessEvent).filter_by(is_suspicious=True).order_by(ProcessEvent.timestamp.desc()).limit(limit).all()
    finally:
        db.close()

def get_recent_automated_responses(limit=20):
    db = get_db()
    try:
        return db.query(AutomatedResponse).order_by(AutomatedResponse.timestamp.desc()).limit(limit).all()
    finally:
        db.close()
